<% include layout/head %>
<% include layout/header %>
<% include layout/sidebar %>
<section class="wrapper p-0">
    <div class="table-agile-info p-0">
        <div class="panel panel-default">
            <div class="panel-heading">
                Thống kê hóa đơn
            </div>
            <div class="text-center $('#table_ds_hoa_don').DataTable();">
                <div class="mt-3 d-inline-block  text-center">
                    <div class="form-group float-left mr-2 d-block">
                        <label for=""><strong>Từ ngày</strong></label>
                        <input type="date" class="form-control pr-0" name="" id="dateFrom">
                    </div>
                    <div class="form-group float-left ml-2">
                        <label for=""><strong>Đến ngày</strong></label>
                        <input type="date" class="form-control pr-0" name="" id="dateTo">
                    </div>
                </div>
                <div class="row">
                    <div class="w-50">
                        <button id="btn_tim" class="btn btn-group-lg btn-success float-right mr-1"><i class="fa fa-search">
                                Tìm</i></button>
                    </div>
                    <div class="w-50">
                        <div class="dropdown float-left ml-1">
                            <button class="btn btn-success dropdown-toggle " type="button" id="dropdownMenuButton"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-align-justify"></i>
                            </button>
                            <div class="float-right">
                                <div class="dropdown-menu dropdown-menu-right bg-success float-right"
                                    aria-labelledby="dropdownMenuButton">
                                    <div class="dropdown-item form-group form-check">
                                        <input type="checkbox" class="form-check-input" id="check_ghichu"
                                            onclick="check_ghichu()">
                                        <label class="form-check-label">Ghi chú</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <table id="table_ds_hoa_don"
                class="table table-striped table-bordered bg-light table-hover d-md-table table-responsive-sm">
                <thead>
                    <tr>

                        <th>Mã Hóa đơn</th>
                        <th>Tên khách hàng</th>
                        <th>Người lập</th>
                        <th>Ngày</th>
                        <th>Tổng tiền</th>
                        <th class="table_ghichu d-none">Ghi chú</th>

                    </tr>
                </thead>
                <tbody id="TH_ds_hoa_don">
                    
                </tbody>
            </table>
            <div class="modal fade" id="modal-detai" tabindex="-1" role="dialog" aria-labelledby="modelTitleId"
                aria-hidden="true">
                <div class="modal-dialog modal-xl" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Chi tiết hóa đơn</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" id="TH_modal_detail">
                            <div class="row w-100">
                                <div class="h3 text-primary mr-auto">Hóa đơn 123</div>
                                <div class="h3 text-danger">Tổng tiền:288,000 VNĐ</div>
                            </div>
                            <div class="row w-100">
                                <div class="h6 mr-auto">Người lập: NVA</div>
                                <div class="h6">Ngày lập: 1-1-2019</div>
                            </div>
                            <div class="row w-100">
                                <div class="h6 mr-auto">Khách hàng: Khách lẻ</div>
                                <div class="h6">Tình trạng:Đã thanh toán</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12">

                                </div>
                                <div class="col-sm-12">
                                    <table
                                        class="table table-striped table-hover table-bordered table-responsive d-lg-table">
                                        <thead>
                                            <tr>
                                                <th>Mã sản phẩm</th>
                                                <th>Tên sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th>Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>1</td>
                                                <td>1</td>
                                                <td>2</td>
                                                <td>3</td>
                                            </tr>
                                            <tr>
                                                <td>5</td>
                                                <td>3</td>
                                                <td>2</td>
                                                <td>9</td>
                                            </tr>

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="btn_in_hoa_don"
                                data-dismiss="modal">Xuất hóa đơn</button>
                            <button type="button" class="btn btn-secondary" id="btn_close_detai"
                                data-dismiss="modal">Đóng</button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="w-auto h-75">
        <div class="col-sm-12 px-0" id="Th_Bieu_do"></div>
    </div>
    <% include layout/footer %>
    <script>
    var ma_hd_in;
    btn_in_hoa_don.onclick=()=>{
        window.open('/users/in-hoa-don/'+ma_hd_in, '_blank');
    }
    function show_chi_tiet_hoa_don(mahd) {
        ma_hd_in=mahd;
        $.ajax({
            url: window.location.origin +'/tim-kiem/hoa-don',
            type: "POST",
            data:{'id_hd':mahd},
            success: (data) => {
                var ct = ``;
                var tongtien = 0;
                data[0].chi_tiet.forEach(row => {
                    tongtien += (row.so_luong) * (row.gia_ban);
                    ct += `
                        <tr>
                            <td>${row.san_pham._id}</td>
                            <td>${row.san_pham.ten_sp}</td>
                            <td>${row.gia_ban}</td>
                            <td>${row.so_luong}</td>
                            <td>${((row.so_luong)*(row.gia_ban)).toLocaleString('en-GB')}</td>
                        </tr>
                    `
                });
                TH_modal_detail.innerHTML = `
                    <div class="row w-100">
                        <div class="h3 text-primary mr-auto">Hóa đơn ${data[0].ma_hd}</div>
                        <div class="h3 text-danger">Tổng tiền:${(tongtien).toLocaleString('en-GB')} VNĐ</div>
                    </div>
                    <div class="row w-100">
                        <div class="h6 mr-auto">Người lập: ${data[0].nhan_vien[0].ho_ten}</div>
                        <div class="h6">Ngày lập: ${data[0].ngay_lap}</div>
                    </div>
                    <div class="row w-100">
                        <div class="h6 mr-auto">Khách hàng: ${data[0].khach_hang[0].ho_ten}</div>
                        <div class="h6">Tình trạng:${data[0].trang_thai}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">

                        </div>
                        <div class="col-sm-12">
                            <table class="table table-striped table-hover table-bordered table-responsive d-lg-table">
                                <thead>
                                    <tr>
                                        <th>Mã sản phẩm</th>
                                        <th>Tên sản phẩm</th>
                                        <th>Số lượng</th>
                                        <th>Giá bán</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                ${ct}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `
            }
        })

}
    </script>
    <script>
        dateFrom.value = new Date(Date.now()).toISOString().split('T')[0]
        dateTo.value = new Date(Date.now()).toISOString().split('T')[0]
        function tinh_tong_tien(Danh_sach) {
            var tong_tien = 0;
            Danh_sach.forEach(row => {
                tong_tien += row.so_luong * row.gia_ban
            });
            return tong_tien;
        }
        btn_tim.onclick = () => {
            var ds;
            var arrngay = [];
            var arrtongtien = [];
            $.ajax({
                url: window.location.origin+'/admin/thong-ke-hoa-don',
                type: "POST",
                success: (data) => {
                    var from = new Date(dateFrom.value)
                    var to = new Date(dateTo.value)
                    to.setDate(to.getDate() + 1)
                    ds = data.filter(x => x.ngay_lap >= dateFrom.value).filter(x => x.ngay_lap <= to.toISOString().split('T')[0])
                    //xuất ra table
                    TH_ds_hoa_don.innerHTML=``
                    var dem=1;
                    ds.forEach(row => {
                        dem++;
                        TH_ds_hoa_don.innerHTML+=`
                        <tr onclick="show_chi_tiet_hoa_don('${row._id}')" data-toggle="modal" data-target="#modal-detai">
                            <td>${row.ma_hd}</td>
                            <td>${row.khach_hang[0].ho_ten}</td>
                            <td>${row.nhan_vien[0].ho_ten}</td>
                            <td>${row.ngay_lap.split('T')[0]}</td>
                            <td>${tinh_tong_tien(row.chi_tiet).toLocaleString('en-GB')} VNĐ</td>
                            <td class="table_ghichu d-none">${row.ghi_chu}</td>
                        </tr>
                        `
                        if(dem==ds.length)
                        {
                            $('#table_ds_hoa_don').DataTable();
                            
                            document.getElementById('table_ds_hoa_don_filter').classList.add('w-100')
                            document.getElementById('table_ds_hoa_don_filter').classList.add('text-right')
                            document.getElementById('table_ds_hoa_don_wrapper').classList.add('pb-4')
                        }
                    });
                        
                    //kết thúc xuất ra table
                    var dem = 0;
                    while (from <= to) {
                        arrngay.push(from.toISOString().split('T')[0])
                        var tien = 0
                        ds.forEach(row => {
                            if (row.ngay_lap.toString().indexOf(from.toISOString().split('T')[0]) >=
                                0) {
                                tien += tinh_tong_tien(row.chi_tiet)
                            }
                        });
                        arrtongtien.push(tien)
                        from.setDate(from.getDate() + 1)
                    }
                    arrngay.pop();
                    arrtongtien.pop();
                    Highcharts.chart('Th_Bieu_do', {
                        chart: {
                            type: 'column', // bar , column, line, pie
                            plotBorderWidth: 1
                        },
                        title: {
                            text: 'Thống kê hóa đơn',
                            align: 'center',
                            style: {
                                color: 'red',
                                fontWeight: 'bold',
                                fontSize: '1.5rem'
                            },
                            y: 20
                        },
                        subtitle: {
                            text: `từ ${dateFrom.value} đến ${dateTo.value}`
                        },
                        xAxis: {
                            categories: arrngay
                        },
                        yAxis: {
                            title: {
                                text: 'Tổng tiền hóa đơn',

                                style: {
                                    color: 'blue',
                                    fontWeight: 'bold',
                                    fontSize: '1rem'
                                }

                            }
                        },
                        series: [{
                            name: 'Tổng tiền',
                            data: arrtongtien,
                            color: 'red'
                        }]

                    });
                
                }
            })
            
        }

        Highcharts.setOptions({
            lang: {
                numericSymbols: [` Ngàn`, ` Triệu`],
                numericSymbolMagnitude: 1000,
                decimalPoint: ',', ///phân cách thập phân
                thousandsSep: '.' ///hàng ngàn
            },
            chart: {
                style: {
                    fontFamily: `tahoma`, /// chỉnh font cho chữ thống dc đúng
                    fontSize: 16
                }
            }
        })
        btn_tim.click();
    </script>